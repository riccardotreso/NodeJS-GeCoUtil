

var sql = require('mssql'); 
//http://pekim.github.io/tedious/api-connection.html
//https://npmjs.org/package/mssql

var config = {
    user: '...',
    password: '...',
    server: '...',
    database: '...',
	port: 1433
	
}

String.prototype.format = function() {
    var args = arguments;
    return this.replace(/{(\d+)}/g, function(match, number) { 
      return typeof args[number] != 'undefined'
        ? args[number]
        : match
      ;
    });
};




GeCoModel = function(server, instance, port, database, user, password ) {
	
	//inizialize variable
	config.server = server;
	config.database = database;
	config.user = user;
	config.password = password;
	if(instance)
		config.instance = instance;
	if(port)
		config.port = port;
	
};

GeCoModel.prototype.getConnection = function(callback, query) {
	var connection = new sql.Connection(config,function(err) {
		if(err) callback(err);
		else
		{
			var request = connection.request();
			
			request.query(query, function(err, recordset) {
				if(err) callback(err);
				else
				{
					callback(null,recordset);
				}
			});
		}
		
		
	
	});
};

GeCoModel.prototype.getUserById = function(callback, filter) {
	var query = "select * from ViewUtentiGruppiTestate where 1=1 and "; 
	if(isNaN(filter))
		query += "nomeutente like '%{0}%'".format(filter);
	else
		query += "idutente = {0}".format(filter);
		
	query += " AND 1=1 order by nomeutente,desgruppoutente,destestata "; //prevent sql injection
	
	console.log(query);
	
    this.getConnection(function(err, recordSet) {
      if( err ) callback(err)
      else {
		callback(null, recordSet);
      }
    }, query);
};


GeCoModel.prototype.getUserByTestata = function(callback, filter) {


	var query = "select * from ViewUtentiGruppiTestate where 1=1 and "; 
	if(isNaN(filter))
		query += "destestata like '%{0}%'".format(filter);
	else
		query += "idtestata = {0}".format(filter);
		
	query += " AND 1=1 order by nomeutente,desgruppoutente,destestata "; //prevent sql injection
	
	console.log(query);
	
    this.getConnection(function(err, recordSet) {
      if( err ) {
		console.log(err)
		callback(err)
		
	}
      else {
		callback(null, recordSet);
      }
    }, query);
};

GeCoModel.prototype.getUserByGruppo = function(callback, filter) {
	var query = "select * from ViewUtentiGruppiTestate where 1=1 and "; 
	if(isNaN(filter))
		query += "desgruppoutente like '%{0}%'".format(filter);
	else
		query += "idgruppoutente = {0}".format(filter);
		
	query += " AND 1=1 order by nomeutente,desgruppoutente,destestata "; //prevent sql injection
	
	console.log(query);
	
    this.getConnection(function(err, recordSet) {
      if( err ) callback(err)
      else {
		callback(null, recordSet);
      }
    }, query);
};





exports.GeCoModel = GeCoModel;